<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>用戶中心 - CEH 測試系统</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }
      .header h1 {
        margin: 0;
        color: #333;
      }
      .nav-links {
        display: flex;
        gap: 20px;
      }
      .nav-links a {
        text-decoration: none;
        color: #4caf50;
        font-weight: bold;
      }
      #logout-btn {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      #logout-btn:hover {
        background-color: #d32f2f;
      }
      .dashboard-section {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 40px;
        transition: all 0.3s ease;
      }
      .dashboard-section:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }
      .section-title {
        margin-top: 0;
        color: #333;
        font-size: 1.6rem;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }
      .stat-card {
        background-color: #f9f9f9;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease;
      }
      .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #4caf50;
        margin: 10px 0;
      }
      .stat-label {
        color: #666;
      }
      .progress-bar-container {
        background-color: #eef2f7;
        border-radius: 10px;
        height: 16px;
        margin: 25px 0;
        overflow: hidden;
      }
      .progress-bar {
        background: linear-gradient(90deg, #4caf50, #45a049);
        height: 100%;
        border-radius: 10px;
        transition: width 0.8s ease;
        text-align: right;
        color: white;
        padding-right: 10px;
        box-sizing: border-box;
        line-height: 20px;
        font-size: 12px;
      }
      .table-container {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
        font-weight: bold;
      }
      tr:hover {
        background-color: #f9f9f9;
      }
      .review-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
      }
      .review-btn:hover {
        background-color: #45a049;
      }
      .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      .status-correct {
        background-color: #e8f5e9;
        color: #2e7d32;
      }
      .status-wrong {
        background-color: #ffebee;
        color: #c62828;
      }
      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      .pagination button {
        background-color: #f2f2f2;
        border: none;
        color: #333;
        padding: 8px 12px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      .pagination button.active {
        background-color: #4caf50;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 50px 0;
        color: #999;
      }
      .empty-state p {
        margin-bottom: 20px;
      }
      .quiz-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
      }
      .quiz-btn:hover {
        background-color: #45a049;
      } /* 模糊效果和升級提示樣式 */
      .premium-feature {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        min-height: 500px; /* 增加最小高度確保內容完整顯示 */
      }

      .premium-blur {
        position: relative;
        height: 100%;
        width: 100%;
      }

      .premium-blur::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        background-color: rgba(255, 255, 255, 0.2);
        z-index: 5;
      }

      .upgrade-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 1000;
        display: flex !important; /* 強制顯示 */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
        border-radius: 8px;
      }

      /* 修改圖標容器樣式使其在兩個區域表現一致 */
      .upgrade-overlay .icon-container {
        width: 80px;
        height: 80px;
        background: rgba(255, 152, 0, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
      }

      .upgrade-overlay .icon-container i {
        font-size: 40px;
        color: #ff9800;
      }

      @keyframes blurPulse {
        0% {
          backdrop-filter: blur(6px);
          -webkit-backdrop-filter: blur(6px);
        }
        100% {
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        }
      }

      /* 為模糊元素添加閃光邊框效果 */
      .premium-blur::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 4;
        pointer-events: none;
        border: 2px solid rgba(255, 165, 0, 0.6);
        border-radius: 8px;
        box-sizing: border-box;
        animation: pulseBorder 2s infinite alternate;
      }

      @keyframes pulseBorder {
        0% {
          box-shadow: 0 0 5px rgba(255, 165, 0, 0.3);
        }
        100% {
          box-shadow: 0 0 15px rgba(255, 165, 0, 0.7);
        }
      }
      .upgrade-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0; /* 確保完整覆蓋 */
        bottom: 0; /* 確保完整覆蓋 */
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85); /* 稍微調深背景色 */
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 1000; /* 提高層級確保顯示在最上層 */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
        border-radius: 8px;
        opacity: 1; /* 確保完全不透明 */
      }

      .upgrade-overlay:hover {
        background: rgba(0, 0, 0, 0.75);
      }

      @keyframes overlayFadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .upgrade-overlay .icon-container {
        margin-bottom: 20px;
        font-size: 40px;
        color: #ff9800;
        background: rgba(255, 152, 0, 0.1);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(255, 152, 0, 0.2);
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .upgrade-overlay h3 {
        color: #ffffff;
        margin-bottom: 15px;
        font-size: 24px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .upgrade-overlay p {
        text-align: center;
        margin: 0 auto 25px;
        max-width: 500px;
        line-height: 1.6;
        color: #ffffff;
        margin-bottom: 25px;
        font-size: 16px;
        max-width: 400px;
        line-height: 1.6;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .upgrade-btn {
        background-color: #ff9800;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .upgrade-btn:hover {
        background-color: #f57c00;
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
      }

      .upgrade-btn::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
      }

      .upgrade-btn:hover::after {
        animation: ripple 1s ease-out;
      }

      @keyframes ripple {
        0% {
          transform: scale(0, 0);
          opacity: 0.5;
        }
        100% {
          transform: scale(20, 20);
          opacity: 0;
        }
      } /* 用戶級別資訊樣式 */
      .user-tier-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .tier-badge {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        color: white;
        margin-right: 20px;
      }

      .free-tier {
        background-color: #78909c;
      }

      .standard-tier {
        background-color: #4caf50;
      }

      .pro-tier {
        background-color: #ff9800;
      }

      .tier-details {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .tier-feature {
        background-color: white;
        padding: 8px 15px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .feature-label {
        color: #666;
        font-size: 14px;
        margin-right: 5px;
      }

      .feature-value {
        font-weight: bold;
        color: #333;
      }

      .tier-actions {
        margin-left: 20px;
      } /* 注意力高亮效果 */
      @keyframes highlightPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(255, 152, 0, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
        }
      }

      .attention-highlight {
        animation: highlightPulse 0.6s ease-out;
      }

      /* 按鈕脈動效果 */
      @keyframes btnPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse-attention {
        animation: btnPulse 1s infinite;
      }

      /* 為升級提示添加豐富的內容樣式 */
      .upgrade-overlay .feature-list {
        margin: 0 auto 25px;
        max-width: 450px;
      }
      .upgrade-overlay .feature-list li {
        margin-bottom: 8px;
        position: relative;
        padding-left: 25px;
        color: #ffffff;
      }

      .upgrade-overlay .feature-list li::before {
        content: "\f00c";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        left: 0;
        color: #4caf50;
      } /* 高級功能區塊樣式 */
      .premium-section {
        display: block; /* 改為顯示 */
        position: relative;
        margin-top: 30px;
      }

      /* 升級提示卡片樣式 */
      .upgrade-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 25px;
        text-align: center;
        margin: 20px 0;
        border: 1px solid #f0f0f0;
        transition: all 0.3s ease;
      }

      .upgrade-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      }

      .upgrade-card .icon {
        font-size: 48px;
        color: #ff9800;
        margin-bottom: 15px;
      }

      .upgrade-card h3 {
        font-size: 22px;
        color: #333;
        margin-bottom: 15px;
      }

      .upgrade-card p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .upgrade-card .feature-tags {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
      }

      .feature-tag {
        background-color: #f5f5f5;
        color: #666;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
      }

      /* 價格選項樣式 */
      .pricing-options {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .pricing-option {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        padding: 25px;
        width: 220px;
        border: 1px solid #eee;
        transition: all 0.3s ease;
        position: relative;
      }

      .pricing-option:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .pricing-option h4 {
        font-size: 20px;
        margin-bottom: 15px;
        color: #333;
      }

      .pricing-option .price {
        font-size: 28px;
        font-weight: bold;
        color: #4caf50;
        margin-bottom: 20px;
      }

      .pricing-option .price span {
        font-size: 16px;
        font-weight: normal;
        color: #666;
      }

      .pricing-option ul {
        list-style: none;
        padding: 0;
        margin: 0 0 25px 0;
        text-align: left;
      }

      .pricing-option ul li {
        padding: 6px 0;
        position: relative;
        padding-left: 22px;
        color: #555;
      }

      .pricing-option ul li::before {
        content: "\f00c";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        color: #4caf50;
        position: absolute;
        left: 0;
      }

      .pricing-option.recommended {
        border: 2px solid #ff9800;
        transform: scale(1.05);
      }

      .pricing-option.recommended:hover {
        transform: translateY(-5px) scale(1.05);
      }

      .recommended-badge {
        position: absolute;
        top: -12px;
        right: 20px;
        background-color: #ff9800;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .standard-btn {
        background-color: #4caf50;
      }

      .standard-btn:hover {
        background-color: #388e3c;
      }

      .pro-btn {
        background-color: #ff9800;
      }
      .pro-btn:hover {
        background-color: #f57c00;
      }

      .error-message {
        background-color: #ffebee;
        color: #c62828;
        padding: 10px 20px;
        border-radius: 4px;
        margin: 10px 0;
        text-align: center;
        border: 1px solid #ef9a9a;
      }
      #analytics-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin: 20px 0;
        min-height: 500px; /* 確保有足夠的高度顯示內容 */
      }
      #category-progress-container,
      #weak-areas-container {
        background: #ffffff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        height: 100%;
        display: flex;
        flex-direction: column;
        text-align: center;
      }
      #category-progress-container h3,
      #weak-areas-container h3 {
        color: #2c3e50;
        font-size: 1.5rem;
        margin-bottom: 25px;
        padding-bottom: 12px;
        border-bottom: 2px solid #eef2f7;
        text-align: center;
      }
      .chart-container {
        width: 100%;
        flex-grow: 1;
        min-height: 350px;
        margin: 15px 0;
        position: relative;
      }
      @media (max-width: 1200px) {
        #analytics-container {
          grid-template-columns: 1fr;
          gap: 30px;
        }
        .chart-container {
          min-height: 400px;
        }
      }

      @media (max-width: 768px) {
        .stats-container {
          grid-template-columns: 1fr;
          gap: 20px;
        }
        .dashboard-section {
          padding: 20px;
          margin-bottom: 30px;
        }
        #category-progress-container,
        #weak-areas-container {
          padding: 20px;
        }
        .chart-container {
          min-height: 350px;
        }
        .section-title {
          font-size: 1.4rem;
          margin-bottom: 20px;
        }
      }

      @media (max-width: 480px) {
        .stat-card {
          padding: 15px;
        }
        .chart-container {
          min-height: 300px;
        }
        #category-progress-container h3,
        #weak-areas-container h3 {
          font-size: 1.3rem;
          margin-bottom: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>用戶中心</h1>
        <div class="nav-links">
          <a href="/">首頁</a>
          <a href="/quiz">測驗平台</a>
          <button id="logout-btn">登出</button>
        </div>
      </div>

      <div class="dashboard-section">
        <h2 class="section-title">會員資訊</h2>
        <div class="user-tier-info">
          <div id="tier-badge" class="tier-badge free-tier">
            <i class="fas fa-user"></i> 免費版
          </div>
          <div class="tier-details">
            <div class="tier-feature">
              <span class="feature-label">每日題目限制：</span>
              <span id="daily-limit" class="feature-value">10</span>
            </div>
            <div class="tier-feature">
              <span class="feature-label">可訪問題庫大小：</span>
              <span id="question-bank-size" class="feature-value">200</span>
            </div>
            <div class="tier-feature">
              <span class="feature-label">今日剩餘題目：</span>
              <span id="remaining-questions" class="feature-value">10</span>
            </div>
          </div>
          <div class="tier-actions">
            <button id="upgrade-btn" class="upgrade-btn">
              <i class="fas fa-crown"></i> 升級會員
            </button>
          </div>
        </div>
      </div>

      <div class="dashboard-section">
        <h2 class="section-title">學習進度總覽</h2>
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-label">已答題數</div>
            <div class="stat-value" id="total-answered">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">正確答題數</div>
            <div class="stat-value" id="correct-count">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">正確率</div>
            <div class="stat-value" id="accuracy">0%</div>
          </div>
        </div>
        <h3>答題正確率</h3>
        <div class="progress-bar-container">
          <div class="progress-bar" id="accuracy-bar" style="width: 0%">0%</div>
        </div>
      </div>
      <div
        class="dashboard-section premium-section"
        id="wrong-questions-section"
      >
        <h2 class="section-title">錯題集</h2>
        <div id="wrong-questions-container" class="premium-feature">
          <div class="table-container">
            <table id="wrong-questions-table">
              <thead>
                <tr>
                  <th>題號</th>
                  <th>題目</th>
                  <th>你的答案</th>
                  <th>正確答案</th>
                  <th>答題時間</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="wrong-questions-body">
                <!-- 錯題將通過JavaScript動態填充 -->
              </tbody>
            </table>
          </div>
          <div class="pagination" id="wrong-questions-pagination">
            <!-- 分頁控制將通過JavaScript動態填充 -->
          </div>
          <div
            class="empty-state"
            id="wrong-questions-empty"
            style="display: none"
          >
            <p>目前沒有錯題記錄</p>
            <a href="/quiz" class="quiz-btn">開始測驗</a>
          </div>
          <div
            class="upgrade-overlay"
            id="wrong-questions-upgrade"
            style="display: none"
          >
            <div class="icon-container">
              <i class="fas fa-lock"></i>
            </div>
            <h3>升級您的帳戶</h3>
            <p>
              錯題集功能僅限標準版或專業版用戶使用。升級您的帳戶以獲取此功能！
            </p>
            <ul class="feature-list">
              <li>查看所有錯誤答題記錄</li>
              <li>針對錯題進行有針對性的練習</li>
              <li>分析錯題類型，提高通過率</li>
            </ul>
            <button class="upgrade-btn" onclick="location.href='/'">
              <span>立即升級</span> <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="dashboard-section premium-section" id="analytics-section">
        <h2 class="section-title">學習進度分析</h2>
        <div id="analytics-container" class="premium-feature">
          <div id="category-progress-container" style="margin-bottom: 30px">
            <h3>類別進度</h3>
            <div id="category-progress" class="stats-container">
              <!-- 類別進度將通過JavaScript動態填充 -->
            </div>
          </div>

          <div id="weak-areas-container">
            <h3>弱項分析</h3>
            <div id="weak-areas" class="stats-container">
              <!-- 弱項分析將通過JavaScript動態填充 -->
            </div>
          </div>
          <div
            class="upgrade-overlay"
            id="analytics-upgrade"
            style="display: none"
          >
            <div class="icon-container">
              <i class="fas fa-chart-line"></i>
            </div>
            <h3>升級您的帳戶</h3>
            <p>
              進階分析功能僅限標準版或專業版用戶使用。升級您的帳戶以獲取深入的學習分析！
            </p>
            <ul class="feature-list">
              <li>詳細的類別進度分析</li>
              <li>個人弱項自動識別</li>
              <li>智能學習路徑推薦</li>
              <li>考試通過率預測</li>
            </ul>
            <button class="upgrade-btn" onclick="location.href='/'">
              <span>立即升級</span> <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="dashboard-section">
        <h2 class="section-title">最近答題記錄</h2>
        <div id="recent-activities-container">
          <div class="table-container">
            <table id="recent-activities-table">
              <thead>
                <tr>
                  <th>題號</th>
                  <th>題目</th>
                  <th>狀態</th>
                  <th>答題時間</th>
                </tr>
              </thead>
              <tbody id="recent-activities-body">
                <!-- 最近活動將通過JavaScript動態填充 -->
              </tbody>
            </table>
          </div>
          <div
            class="empty-state"
            id="recent-activities-empty"
            style="display: none"
          >
            <p>目前沒有答題記錄</p>
            <a href="/quiz" class="quiz-btn">開始測驗</a>
          </div>
        </div>
      </div>
      <div
        class="dashboard-section"
        id="premium-features-card"
        style="display: none"
      >
        <div class="upgrade-card">
          <div class="icon">
            <i class="fas fa-crown"></i>
          </div>
          <h3>升級獲取更多高級功能</h3>
          <p>
            升級到標準版或專業版，即可解鎖更多學習工具，包括錯題集和學習進度分析，助您更快通過CEH考試！
          </p>
          <div class="feature-tags">
            <span class="feature-tag"><i class="fas fa-check"></i> 錯題集</span>
            <span class="feature-tag"
              ><i class="fas fa-check"></i> 學習進度分析</span
            >
            <span class="feature-tag"
              ><i class="fas fa-check"></i> 弱項識別</span
            >
            <span class="feature-tag"
              ><i class="fas fa-check"></i> 題庫擴展</span
            >
          </div>
          <div class="pricing-options">
            <div class="pricing-option">
              <h4>標準版</h4>
              <div class="price">NT$299<span>/月</span></div>
              <ul>
                <li>解鎖錯題集功能</li>
                <li>基礎學習分析</li>
                <li>每日50題</li>
              </ul>
              <button
                class="upgrade-btn standard-btn"
                onclick="location.href='/pricing?plan=standard'"
              >
                <span>選擇標準版</span>
              </button>
            </div>
            <div class="pricing-option recommended">
              <div class="recommended-badge">推薦</div>
              <h4>專業版</h4>
              <div class="price">NT$499<span>/月</span></div>
              <ul>
                <li>全部功能解鎖</li>
                <li>高級學習分析</li>
                <li>無限題目</li>
                <li>模擬考試模式</li>
              </ul>
              <button
                class="upgrade-btn pro-btn"
                onclick="location.href='/pricing?plan=pro'"
              >
                <span>選擇專業版</span> <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 檢測瀏覽器是否支持backdrop-filter
        detectBackdropFilterSupport();

        // 先從 localStorage 檢查用戶是否已登入
        const user = JSON.parse(localStorage.getItem("user") || "null"); // 從服務器檢查會話狀態
        fetch("/api/user/check-session", {
          method: "GET",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("未登入或會話已過期");
          })
          .then((data) => {
            console.log("Session check response:", data); // 調試日誌
            // 用戶已登入，確保本地存儲也有用戶資料
            if (!user) {
              localStorage.setItem(
                "user",
                JSON.stringify({
                  id: data.user_id,
                  username: data.username,
                  is_admin: data.is_admin,
                })
              );
            }

            // 為管理員設置專業版資料
            if (data.is_admin) {
              data.tier = {
                id: 3,
                name: "專業版",
                daily_quiz_limit: 999,
                question_bank_size: 999,
                remaining_daily_questions: 999,
                has_advanced_analytics: true,
                has_wrong_questions_review: true,
                has_mock_exam: true,
              };
            }

            // 檢查用戶級別和權限
            checkUserTier(data);

            // 繼續加載儀表板數據
            loadDashboardData();
          })
          .catch((error) => {
            console.error("Session check error:", error);
            if (error.message === "Login required") {
              localStorage.removeItem("user");
              window.location.href = "/login";
            } else {
              console.error("Error checking session:", error);
              // 顯示錯誤消息給用戶，但不要重定向
              const errorDiv = document.createElement("div");
              errorDiv.className = "error-message";
              errorDiv.textContent = "載入資料時發生錯誤，請稍後再試";
              document.querySelector(".container").prepend(errorDiv);
            }
          });

        // 添加登出功能
        document
          .getElementById("logout-btn")
          .addEventListener("click", function () {
            fetch("/api/logout", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include", // 包含認證信息
            })
              .then((response) => response.json())
              .then((data) => {
                // 清除本地儲存的用戶資料
                localStorage.removeItem("user");
                window.location.href = data.redirect || "/"; // 使用後端返回的重定向地址或默認跳轉到首頁
              })
              .catch((error) => {
                console.error("登出失敗:", error);
                // 即使出錯也清除本地儲存並跳轉到首頁
                localStorage.removeItem("user");
                window.location.href = "/"; // 即使出錯也跳轉到首頁
              });
          }); // 檢測瀏覽器是否支持backdrop-filter
        function detectBackdropFilterSupport() {
          // 創建一個樣式檢測元素
          const testEl = document.createElement("div");
          testEl.style.cssText = "position:absolute;backdrop-filter:blur(2px);";
          document.documentElement.appendChild(testEl);

          // 檢查計算後的樣式是否包含backdrop-filter
          const computedStyle = window.getComputedStyle(testEl);
          const hasSupport =
            (computedStyle.backdropFilter !== undefined &&
              computedStyle.backdropFilter !== "none") ||
            (computedStyle.webkitBackdropFilter !== undefined &&
              computedStyle.webkitBackdropFilter !== "none");

          // 移除測試元素
          document.documentElement.removeChild(testEl);

          // 如果不支持，添加一個類名到body，以便CSS可以提供替代方案
          if (!hasSupport) {
            document.body.classList.add("no-backdrop-filter");
            console.log(
              "This browser does not support backdrop-filter. Using fallback."
            );
          }

          return hasSupport;
        }

        // 更新用戶級別信息
        function updateTierInfo(tierData) {
          if (!tierData) return;

          // 更新級別徽章
          const tierBadge = document.getElementById("tier-badge");

          // 根據級別設置不同的圖標和樣式
          tierBadge.className = "tier-badge";
          if (tierData.name === "免費版" || tierData.id === 1) {
            tierBadge.classList.add("free-tier");
            tierBadge.innerHTML = '<i class="fas fa-user"></i> 免費版';
          } else if (tierData.name === "標準版" || tierData.id === 2) {
            tierBadge.classList.add("standard-tier");
            tierBadge.innerHTML = '<i class="fas fa-award"></i> 標準版';
          } else if (tierData.name === "專業版" || tierData.id === 3) {
            tierBadge.classList.add("pro-tier");
            tierBadge.innerHTML = '<i class="fas fa-crown"></i> 專業版';
          }

          // 更新級別詳情
          document.getElementById("daily-limit").textContent =
            tierData.daily_quiz_limit;
          document.getElementById("question-bank-size").textContent =
            tierData.question_bank_size;
          document.getElementById("remaining-questions").textContent =
            tierData.remaining_daily_questions;

          // 如果是專業版用戶，隱藏升級按鈕
          const upgradeBtn = document.getElementById("upgrade-btn");
          if (tierData.name === "專業版" || tierData.id === 3) {
            upgradeBtn.style.display = "none";
          } else if (!window.userTierInfo?.isAdmin) {
            // 如果不是管理員才顯示升級按鈕
            upgradeBtn.style.display = "block";
            upgradeBtn.addEventListener("click", function () {
              window.location.href = "/"; // 跳轉到首頁，可以改為升級頁面的URL
            });
          }
        }

        // 根據用戶級別處理高級功能顯示
        function checkUserTier(data) {
          console.log("User data:", data); // 調試用
          // 檢查用戶是否是管理員
          const isAdmin = data.is_admin === true || data.is_admin === 1;
          console.log("Is admin:", isAdmin); // 調試用

          // 如果是管理員，直接設置專業版權限
          if (isAdmin) {
            const adminTierData = {
              name: "專業版",
              id: 3,
              daily_quiz_limit: 999,
              question_bank_size: 999,
              remaining_daily_questions: 999,
              has_advanced_analytics: true,
              has_wrong_questions_review: true,
              has_mock_exam: true,
            };

            console.log("Setting admin tier data:", adminTierData); // 調試用

            // 更新用戶級別信息
            updateTierInfo(adminTierData);

            // 設置所有高級功能為可用
            window.userTierInfo = {
              isAdmin: true,
              isFreeUser: false,
              hasWrongQuestionsReview: true,
              hasAdvancedAnalytics: true,
              hasMockExam: true,
              questionBankSize: 999,
            };

            // 立即顯示所有高級功能
            const premiumSections =
              document.querySelectorAll(".premium-section");
            premiumSections.forEach((section) => {
              section.style.display = "block";
              section.classList.remove("premium-section");
            });

            // 隱藏所有升級提示
            const upgradeOverlays =
              document.querySelectorAll(".upgrade-overlay");
            upgradeOverlays.forEach(
              (overlay) => (overlay.style.display = "none")
            );

            // 立即隱藏升級按鈕
            const upgradeBtn = document.getElementById("upgrade-btn");
            if (upgradeBtn) upgradeBtn.style.display = "none";

            return; // 提前結束函數
          }

          const isFreeUser =
            !isAdmin &&
            (!data.tier || data.tier?.name === "免費版" || data.tier?.id === 1);

          // 獲取所有相關區塊
          const wrongQuestionsSection = document.getElementById(
            "wrong-questions-section"
          );
          const analyticsSection = document.getElementById("analytics-section");
          const premiumFeaturesCard = document.getElementById(
            "premium-features-card"
          );
          const analyticsUpgrade = document.getElementById("analytics-upgrade");
          const wrongQuestionsUpgrade = document.getElementById(
            "wrong-questions-upgrade"
          );

          if (isAdmin) {
            // 管理員顯示所有功能，隱藏所有升級提示
            if (wrongQuestionsSection) {
              wrongQuestionsSection.style.display = "block";
              wrongQuestionsSection.classList.remove("premium-section");
            }
            if (analyticsSection) {
              analyticsSection.style.display = "block";
              analyticsSection.classList.remove("premium-section");
            }
            if (premiumFeaturesCard) premiumFeaturesCard.style.display = "none";
            if (analyticsUpgrade) analyticsUpgrade.style.display = "none";
            if (wrongQuestionsUpgrade)
              wrongQuestionsUpgrade.style.display = "none";

            // 為管理員設置專業版標記
            updateTierInfo({
              name: "專業版",
              id: 3,
              daily_quiz_limit: 999,
              question_bank_size: 999,
              remaining_daily_questions: 999,
              has_advanced_analytics: true,
              has_wrong_questions_review: true,
              has_mock_exam: true,
            });

            // 隱藏升級按鈕
            const upgradeBtn = document.getElementById("upgrade-btn");
            if (upgradeBtn) upgradeBtn.style.display = "none";
          } else if (isFreeUser) {
            // 免費用戶隱藏高級功能，顯示升級卡片
            if (wrongQuestionsSection) {
              wrongQuestionsSection.style.display = "block";
              const container = wrongQuestionsSection.querySelector(
                "#wrong-questions-container"
              );
              if (container) {
                container.classList.add("premium-blur");
              }
              const overlay = wrongQuestionsSection.querySelector(
                "#wrong-questions-upgrade"
              );
              if (overlay) {
                overlay.style.display = "flex";
              }
            }
            if (analyticsSection) {
              analyticsSection.style.display = "block";
              const container = analyticsSection.querySelector(
                "#analytics-container"
              );
              if (container) {
                container.classList.add("premium-blur");
              }
              if (analyticsUpgrade) {
                analyticsUpgrade.style.display = "flex";
              }
            }
            if (premiumFeaturesCard) {
              premiumFeaturesCard.style.display = "block";
            }
          } else {
            // 付費用戶顯示已解鎖的功能
            if (wrongQuestionsSection) {
              wrongQuestionsSection.style.display = "block";
              const container = wrongQuestionsSection.querySelector(
                "#wrong-questions-container"
              );
              if (container) {
                container.classList.remove("premium-blur");
              }
              const overlay = wrongQuestionsSection.querySelector(
                "#wrong-questions-upgrade"
              );
              if (overlay) {
                overlay.style.display = "none";
              }
            }
            if (analyticsSection) {
              analyticsSection.style.display = "block";
              const container = analyticsSection.querySelector(
                "#analytics-container"
              );
              if (container) {
                container.classList.remove("premium-blur");
              }
              if (analyticsUpgrade) {
                analyticsUpgrade.style.display = "none";
              }
            }
            if (premiumFeaturesCard) {
              premiumFeaturesCard.style.display = "none";
            }
          }

          // 儲存用戶級別資訊以供其他函數使用
          window.userTierInfo = {
            isAdmin: isAdmin,
            isFreeUser: isFreeUser,
            // 管理員擁有所有權限
            hasWrongQuestionsReview: isAdmin
              ? true
              : data.tier?.has_wrong_questions_review,
            hasAdvancedAnalytics: isAdmin
              ? true
              : data.tier?.has_advanced_analytics,
            hasMockExam: isAdmin ? true : data.tier?.has_mock_exam,
            questionBankSize: isAdmin
              ? 999
              : data.tier?.question_bank_size || 200,
          };
        }

        // 為高級功能添加吸引注意力的動畫
        function animateAttention(element) {
          setTimeout(() => {
            element.classList.add("attention-highlight");
            setTimeout(() => {
              element.classList.remove("attention-highlight");
            }, 600);
          }, 500);

          // 再次高亮，增加注意力
          setTimeout(() => {
            element.classList.add("attention-highlight");
            setTimeout(() => {
              element.classList.remove("attention-highlight");
            }, 600);
          }, 1500);
        } // 儀表板數據加載函數
        function loadDashboardData() {
          fetch("/api/user/progress", {
            credentials: "include",
          })
            .then((response) => {
              if (!response.ok) {
                if (response.status === 401) {
                  throw new Error("Login required");
                }
                return response.json().then((err) => {
                  throw new Error(err.error || "Server error");
                });
              }
              return response.json();
            })
            .then((data) => {
              // 更新進度統計
              document.getElementById("total-answered").textContent =
                data.overall.total_answered;
              document.getElementById("correct-count").textContent =
                data.overall.correct_count;
              const accuracy = data.overall.accuracy.toFixed(1);
              document.getElementById("accuracy").textContent = accuracy + "%";

              // 更新用戶級別顯示
              if (data.user_tier) {
                const tierBadge = document.getElementById("tier-badge");
                if (data.user_tier.is_admin) {
                  tierBadge.className = "tier-badge pro-tier";
                  tierBadge.innerHTML = '<i class="fas fa-crown"></i> 專業版';

                  // 更新管理員的其他顯示
                  document.getElementById("daily-limit").textContent = "無限";
                  document.getElementById("question-bank-size").textContent =
                    "無限";
                  document.getElementById("remaining-questions").textContent =
                    "無限";
                } else {
                  // 非管理員用戶的顯示邏輯
                  const tierClass =
                    data.user_tier.name === "專業版"
                      ? "pro-tier"
                      : data.user_tier.name === "標準版"
                      ? "standard-tier"
                      : "free-tier";
                  const iconClass =
                    data.user_tier.name === "專業版"
                      ? "fa-crown"
                      : data.user_tier.name === "標準版"
                      ? "fa-award"
                      : "fa-user";
                  tierBadge.className = `tier-badge ${tierClass}`;
                  tierBadge.innerHTML = `<i class="fas ${iconClass}"></i> ${data.user_tier.name}`;
                }
              }

              // 更新進度條
              const accuracyBar = document.getElementById("accuracy-bar");
              accuracyBar.style.width = accuracy + "%";
              accuracyBar.textContent = accuracy + "%";

              // 更新最近答題記錄
              updateRecentActivities(data.recent_activities);

              // 處理高級分析數據
              handleAnalyticsData(data);
            })
            .catch((error) => {
              console.error("Progress data error:", error);
              // 顯示錯誤消息給用戶
              const errorDiv = document.createElement("div");
              errorDiv.className = "error-message";
              errorDiv.textContent = "載入進度資料時發生錯誤，請稍後再試";
              document.querySelector(".container").prepend(errorDiv);
            });

          // 處理錯題集數據
          if (window.userTierInfo && !window.userTierInfo.isFreeUser) {
            loadWrongQuestions();
          }
        }

        function updateRecentActivities(activities) {
          const recentActivitiesBody = document.getElementById(
            "recent-activities-body"
          );
          const recentActivitiesEmpty = document.getElementById(
            "recent-activities-empty"
          );

          if (activities && activities.length > 0) {
            recentActivitiesEmpty.style.display = "none";
            recentActivitiesBody.innerHTML = "";

            activities.forEach((activity) => {
              const row = document.createElement("tr");

              const questionNumberCell = document.createElement("td");
              questionNumberCell.textContent = activity.question_number;
              row.appendChild(questionNumberCell);

              const questionTextCell = document.createElement("td");
              questionTextCell.textContent =
                activity.question_text.length > 50
                  ? activity.question_text.substring(0, 50) + "..."
                  : activity.question_text;
              row.appendChild(questionTextCell);

              const statusCell = document.createElement("td");
              const statusBadge = document.createElement("span");
              statusBadge.classList.add("status-badge");
              statusBadge.classList.add(
                activity.is_correct ? "status-correct" : "status-wrong"
              );
              statusBadge.textContent = activity.is_correct ? "正確" : "錯誤";
              statusCell.appendChild(statusBadge);
              row.appendChild(statusCell);

              const timeCell = document.createElement("td");
              const date = new Date(activity.answer_time);
              timeCell.textContent = date.toLocaleString();
              row.appendChild(timeCell);

              recentActivitiesBody.appendChild(row);
            });
          } else {
            recentActivitiesEmpty.style.display = "block";
          }
        }

        function handleAnalyticsData(data) {
          const analyticsSection = document.getElementById("analytics-section");
          const analyticsUpgrade = document.getElementById("analytics-upgrade");

          if (
            data.category_progress &&
            (window.userTierInfo.hasAdvancedAnalytics ||
              window.userTierInfo.isAdmin)
          ) {
            if (analyticsSection) analyticsSection.style.display = "block";
            if (analyticsUpgrade) analyticsUpgrade.style.display = "none";

            renderCategoryProgress(data.category_progress);
            if (data.weak_areas) {
              renderWeakAreas(data.weak_areas);
            }
          } else {
            if (analyticsSection) analyticsSection.style.display = "block";
            if (analyticsUpgrade) analyticsUpgrade.style.display = "block";
          }
        }

        function loadWrongQuestions() {
          fetch("/api/user/wrong-questions", {
            credentials: "include",
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to load wrong questions");
              }
              return response.json();
            })
            .then((data) => {
              const tbody = document.getElementById("wrong-questions-body");
              const emptyState = document.getElementById(
                "wrong-questions-empty"
              );

              if (data && data.length > 0) {
                tbody.innerHTML = "";
                emptyState.style.display = "none";

                data.forEach((item) => {
                  const row = document.createElement("tr");

                  // 题号
                  const questionNumberCell = document.createElement("td");
                  questionNumberCell.textContent = item.question_number;

                  // 题目
                  const questionTextCell = document.createElement("td");
                  questionTextCell.textContent =
                    item.question_text.length > 50
                      ? item.question_text.substring(0, 50) + "..."
                      : item.question_text;

                  // 错误答案
                  const wrongAnswerCell = document.createElement("td");
                  wrongAnswerCell.textContent = item.wrong_answer;

                  // 正确答案
                  const correctAnswerCell = document.createElement("td");
                  correctAnswerCell.textContent = item.correct_answer;

                  // 答题时间
                  const timeCell = document.createElement("td");
                  const date = new Date(item.answered_at);
                  timeCell.textContent = date.toLocaleString();

                  // 操作按钮
                  const actionCell = document.createElement("td");
                  const reviewButton = document.createElement("button");
                  reviewButton.className = "review-btn";
                  reviewButton.textContent = "復習";
                  reviewButton.onclick = () => {
                    window.location.href = `/quiz?question=${item.question_number}`;
                  };
                  actionCell.appendChild(reviewButton);

                  // 添加所有單元格到行
                  row.appendChild(questionNumberCell);
                  row.appendChild(questionTextCell);
                  row.appendChild(wrongAnswerCell);
                  row.appendChild(correctAnswerCell);
                  row.appendChild(timeCell);
                  row.appendChild(actionCell);

                  tbody.appendChild(row);
                });
              } else {
                tbody.innerHTML = "";
                emptyState.style.display = "block";
              }
            })
            .catch((error) => {
              console.error("Error loading wrong questions:", error);
              const errorDiv = document.createElement("div");
              errorDiv.className = "error-message";
              errorDiv.textContent = "載入錯題集時發生錯誤，請稍後再試";
              document
                .getElementById("wrong-questions-container")
                .prepend(errorDiv);
            });
        }
      });
    </script>
  </body>
</html>
